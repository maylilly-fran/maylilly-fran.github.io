<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>„ÄêÈà¥Ëò≠„ÅÆÂâ£„Äë„Éï„É©„É≥„Å™„ÉÑ„Éº„É´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="status.css">
</head>

<body class="bg-gray-100 p-6">

    <div class="max-w-6xl mx-auto" style="max-width: 80rem;">
        <div class="controls">
            <button class="reloadBtn" onclick="reloadPage()">üîÑ</button>
            <button class="characterbtn" onclick="goToNextPage()">„Ç≠„É£„É©„ÇØ„Çø‰∏ÄË¶ß„Å∏</button>
            <button class="statusInheritanceBtn" id="statusInheritanceBtn"
                onclick="toggleInheritance()">„Éá„Éº„ÇøÂºïÁ∂ô„ÅéOFF</button>
            <button class="movebtn" onclick="toggleSortable()" id="toggleSortBtn">Ë°å‰∏¶„Å≥Êõø„ÅàOFF</button>
            <button class="highlightbtn" onclick="toggleHighlight()" id="toggleHighlightBtn">„Éï„Ç£„É´„Çø„É¢„Éº„Éâ</button>
        </div>
        <div class="controls2">
            <input id="ltInput" type="number" min="0" step="1" style="text-align: center;"/> ‚â¶ 
            <select id="gtltFilter" style="border-radius: 10px; text-align: center;">
                <option value="hp">HP</option>
                <option value="atk">Áâ©Êîª</option>
                <option value="def">Áâ©Èò≤</option>
                <option value="matk">È≠îÊîª</option>
                <option value="mdef">È≠îÈò≤</option>
                <option value="hpmax">HPMAX</option>
                <option value="atkmax">Áâ©ÊîªMAX</option>
                <option value="defmax">Áâ©Èò≤MAX</option>
                <option value="matkmax">È≠îÊîªMAX</option>
                <option value="mdefmax">È≠îÈò≤MAX</option>
                <option value="speed">Á¥†Êó©„Åï</option>
            </select>‚â¶
            <input id="gtInput" type="number" min="0" step="1" style="text-align: center;"/>
            <select id="or-and" style="border-radius: 10px; text-align: center; margin-left: 10px;">
                <option value="and">AND</option>
                <option value="or">OR</option>
            </select>
        </div>
        <div class="controls2">
            <input id="searchInput" type="text" placeholder="Ê§úÁ¥¢...[„Çπ„Éö„Éº„Çπ„ÄÅ„Ç´„É≥„Éû„ÄÅ„Çª„Éü„Ç≥„É≠„É≥„ÅÆ„ÅÑ„Åö„Çå„Åã„ÅßË§áÊï∞Êù°‰ª∂„ÅÆÊ§úÁ¥¢„ÅåÂèØËÉΩ]"
                class="mb-4 px-4 py-2 w-full border rounded">
        </div>

        <div class="overflow-x-auto">
            <table id="csv-table" class="table-auto min-w-full bg-white shadow-md rounded-lg overflow-hidden">
                <thead class="bg-gray-200 text-gray-700">
                    <tr id="csv-header" class="text-left cursor-pointer"></tr>
                </thead>
                <tbody id="csv-body" class="text-gray-800"></tbody>
            </table>
        </div>
    </div>

    <script>
        let filtered = [];
        let originalData = [];
        let headers = [];
        let highlight = [];
        let sortState = { column: null, ascending: true };
        const imageColumnIndex = 1; // ‚Üê ÁîªÂÉèÂàó„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºà0Âßã„Åæ„ÇäÔºâ
        const imageColumnIndex2 = 2;

        const params = new URLSearchParams(location.search);
        const value = localStorage.getItem("text");
        document.getElementById('searchInput').value = value;
        localStorage.removeItem("text");

        function renderTable(data) {
            const body = document.getElementById('csv-body');

            body.innerHTML = data.map((row, rowIndex) => {
                const isHighlighted = highlight.includes(rowIndex);
                const rowClass = `${sortableEnabled ? 'cursor-move' : 'cursor-default'} hover:bg-gray-100 ${isHighlighted ? 'bg-yellow-100' : ''}`;

                return `
        <tr class="${rowClass}">
            ${row.map((cell, colIndex) => {
                    const content = (colIndex === imageColumnIndex || colIndex === imageColumnIndex2)
                        ? `<img src="${cell}" alt="ÁîªÂÉè" class="h-12 object-contain" style="border-radius: 15px;">`
                        : cell;
                    return `<td class="border-t px-4 py-2 whitespace-nowrap"><b>${content}</b></td>`;
                }).join('')}
        </tr>`;
            }).join('');

            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }

            if (sortableEnabled) {
                sortableInstance = Sortable.create(body, {
                    animation: 150,
                    ghostClass: 'bg-yellow-100',
                });
            }
        }

        function sortTableByColumn(colIndex) {
            const ascending = sortState.column === colIndex ? !sortState.ascending : true;
            sortState = { column: colIndex, ascending };

            originalData.sort((a, b) => {
                const aVal = a[colIndex] ?? '';
                const bVal = b[colIndex] ?? '';
                return ascending
                    ? aVal.localeCompare(bVal, 'ja', { numeric: true })
                    : bVal.localeCompare(aVal, 'ja', { numeric: true });
            });

            applyFilterAndRender();
            updateHeaderIndicators();
        }

        function updateHeaderIndicators() {
            const headerRow = headers.map((title, index) => {
                const isSorted = sortState.column === index;
                const arrow = isSorted ? (sortState.ascending ? '‚ñ≤' : '‚ñº') : '';
                return `<th onclick="sortTableByColumn(${index})" class="px-4 py-2 whitespace-nowrap hover:bg-gray-300">${title} ${arrow}</th>`;
            }).join('');
            document.getElementById('csv-header').innerHTML = headerRow;
        }

        function applyFilterAndRender() {
            const keywordInput = document.getElementById('searchInput').value.toLowerCase();
            const keywords = keywordInput.split(/[\s;,]+/).map(k => k.trim()).filter(k => k !== '');
            const ltValue = document.getElementById('ltInput').value.toLowerCase();
            const gtValue = document.getElementById('gtInput').value.toLowerCase();

            if (keywords.length === 0 && ltValue == "" && gtValue == "") {
                highlight = [];
                renderTable(originalData);
                return;
            }

            let filteredWithIndex = originalData
                .map((row, index) => ({ row, index }))
                .filter(item => {
                    let flg = false;
                    for (const keyword of keywords) {
                        let targetColumns = wordCheck(keyword);
                        for (const colIndex of targetColumns) {
                            const cell = item.row[colIndex];
                            if (colIndex === 0 || colIndex === 2) {
                                if (cell && cell.toLowerCase().includes(keyword)) flg = true;
                            } else {
                                if (cell && gtltCheck(keyword, Number(cell))) flg = true;
                            }
                        }
                    }
                    let ltFlg = true;
                    let gtFlg = true;
                    if(ltValue !== "") ltFlg = Number(ltValue) <= Number(item.row[getIndex()]);
                    if(gtValue !== "") gtFlg = Number(item.row[getIndex()]) <= Number(gtValue);

                    if(document.getElementById('or-and').value === "or") return flg || (ltFlg && gtFlg);
                    return flg && ltFlg && gtFlg;
                });

            filtered = filteredWithIndex.map(item => item.row);
            highlight = filteredWithIndex.map(item => item.index);

            if (highlightEnabled) renderTable(originalData);
            else {
                highlight = [];
                renderTable(filtered);
            }
        }

        function getIndex(){
            const val = document.getElementById('gtltFilter').value;
            if(val === "hp") return 3;
            if(val === "atk") return 4;
            if(val === "def") return 5;
            if(val === "matk") return 6;
            if(val === "mdef") return 7;
            if(val === "hpmax") return 8;
            if(val === "atkmax") return 9;
            if(val === "defmax") return 10;
            if(val === "matkmax") return 11;
            if(val === "mdefmax") return 12;
            if(val === "speed") return 13;
        }

        function gtltCheck(keyword, cell) {
            const words = keyword.split(':');
            if (words[1] === "gt") {
                return Number(words[2]) <= cell;
            } else if (words[1] === "lt") {
                return cell <= Number(words[2]);
            } else false;
        }

        function wordCheck(keyword) {
            const targetWords = ["hp:gt:", "hp:lt:", "atk:gt:", "atk:lt:", "def:gt:", "def:lt:", "matk:gt:", "matk:lt:", "mdef:gt:", "mdef:lt", "hpmax:gt:", "hpmax:lt:", "atkmax:gt:", "atkmax:lt:", "defmax:gt:", "defmax:lt:", "matkmax:gt:", "matkmax:lt:", "mdefmax:gt:", "mdefmax:lt:", "speed:gt:", "speed:lt:"];
            const idx = targetWords.findIndex(prefix => keyword.startsWith(prefix))
            if (idx === 0 || idx === 1) {
                return [3];
            } else if (idx === 2 || idx === 3) {
                return [4]
            } else if (idx === 4 || idx === 5) {
                return [5]
            } else if (idx === 6 || idx === 7) {
                return [6]
            } else if (idx === 8 || idx === 9) {
                return [7]
            } else if (idx === 10 || idx === 11) {
                return [8]
            } else if (idx === 12 || idx === 13) {
                return [9]
            } else if (idx === 14 || idx === 15) {
                return [10]
            } else if (idx === 16 || idx === 17) {
                return [11]
            } else if (idx === 18 || idx === 19) {
                return [12]
            } else if (idx === 20 || idx === 21) {
                return [13]
            } else return [0, 2];
        }

        fetch('status.csv')
            .then(res => {
                if (!res.ok) throw new Error('CSV„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return res.text();
            })
            .then(csv => {
                const lines = csv.trim().split('\n').map(l => l.split(','));
                headers = lines[0];
                originalData = lines.slice(1);
                updateHeaderIndicators();
                applyFilterAndRender();
            })
            .catch(err => {
                document.getElementById('csv-body').innerHTML = `
          <tr><td class="p-4 text-red-500" colspan="100%">${err.message}</td></tr>
        `;
            });

        document.getElementById('searchInput').addEventListener('input', applyFilterAndRender);
        document.getElementById('ltInput').addEventListener('input', applyFilterAndRender);
        document.getElementById('gtInput').addEventListener('input', applyFilterAndRender);
        document.getElementById('gtltFilter').addEventListener('change', applyFilterAndRender);
        document.getElementById('or-and').addEventListener('change', applyFilterAndRender);

        function reloadPage() {
            location.reload();
        }

        let sortableInstance = null;
        let sortableEnabled = false;
        function toggleSortable() {
            sortableEnabled = !sortableEnabled;
            document.getElementById("toggleSortBtn").innerText = sortableEnabled ? "Ë°å‰∏¶„Å≥Êõø„ÅàON" : "Ë°å‰∏¶„Å≥Êõø„ÅàOFF";
            applyFilterAndRender();
        }

        let highlightEnabled = false;
        function toggleHighlight() {
            highlightEnabled = !highlightEnabled;
            document.getElementById("toggleHighlightBtn").innerText = highlightEnabled ? "„Éè„Ç§„É©„Ç§„Éà„É¢„Éº„Éâ" : "„Éï„Ç£„É´„Çø„É¢„Éº„Éâ";
            applyFilterAndRender();
        }

        let inheritanceEnabled = false;
        function toggleInheritance() {
            inheritanceEnabled = !inheritanceEnabled;
            document.getElementById("statusInheritanceBtn").innerText = inheritanceEnabled ? "„Éá„Éº„ÇøÂºïÁ∂ô„ÅéON" : "„Éá„Éº„ÇøÂºïÁ∂ô„ÅéOFF";
        }

        function goToNextPage() {
            let text = "";
            if (inheritanceEnabled) {
                filtered.map(row => {
                    row.map((cell,colIndex) => {
                        if(colIndex === 0) text += cell + " ";
                    });
                });
                localStorage.setItem("text", text);
            }
            location.href = `index.html`;
        }
    </script>

</body>

</html>