<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Èà¥Ëò≠„ÅÆÂâ£:„Éï„É©„É≥„Å™„ÉÑ„Éº„É´</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" href="favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="controls">
        <button class="reloadBtn" onclick="reloadPage()">üîÑ</button>
        <input type="text" id="search-input" placeholder="ÂêçÂâç„ÅßÊ§úÁ¥¢">
        <select id="role-filter">
            <option value="all">ÂÖ®„É≠„Éº„É´</option>
            <option value="„Éñ„É¨„Ç§„Ç´„Éº">„Éñ„É¨„Ç§„Ç´„Éº</option>
            <option value="„Éá„Ç£„Éï„Çß„É≥„ÉÄ„Éº">„Éá„Ç£„Éï„Çß„É≥„ÉÄ„Éº</option>
            <option value="„Ç¢„Çµ„É´„Çø„Éº">„Ç¢„Çµ„É´„Çø„Éº</option>
            <option value="„Ç¶„Ç©„ÉÉ„ÉÅ„É£„Éº">„Ç¶„Ç©„ÉÉ„ÉÅ„É£„Éº</option>
            <option value="„Éá„Çπ„Éà„É≠„Ç§„É§„Éº">„Éá„Çπ„Éà„É≠„Ç§„É§„Éº</option>
        </select>
        <select id="sort-order">
            <option value="default">‰∏¶„Å≥È†ÜÔºö„Éá„Éï„Ç©„É´„Éà</option>
        </select>
        <button class="skillbtn" onclick="openModal('categoryModal')">„Çπ„Ç≠„É´„Éï„Ç£„É´„Çø(Œ≤Áâà)</button>
    </div>

    <div class="grid" id="product-grid"></div>
    <div class="pagination" id="pagination"></div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="product-modal">
        <div class="modal-content">
            <span class="close" id="close-modal">&times;</span>
            <div id="modal-body">
                <div class="container">
                    <div class="left">
                        <div id="characterImg"></div>
                        <div id="characterName"></div>
                        <div id="characterRole"></div>
                        <div id="characterWeapon"></div>
                        <button id="toggleButton" onclick="toggleAudio()" disabled>‚ñ∂</button>
                        <div id="player"></div>
                    </div>

                    <div class="right">
                        <div id="personalityImg"></div>
                        <div id="personalityTitle"></div>
                        <div id="common"></div>
                        <div class="tab-buttons">
                            <div class="tab-button active" data-tab="hoshi5">‚òÜ5</div>
                            <div class="tab-button" data-tab="hoshi4">‚òÜ4</div>
                            <div class="tab-button" data-tab="hoshi3">‚òÜ3</div>
                            <div class="tab-button" data-tab="hoshi2">‚òÜ2</div>
                            <div class="tab-button" data-tab="hoshi1">‚òÜ1</div>
                        </div>
                        <div class="tab-content active" id="hoshi5" style="text-align: left"></div>
                        <div class="tab-content" id="hoshi4" style="text-align: left"></div>
                        <div class="tab-content" id="hoshi3" style="text-align: left"></div>
                        <div class="tab-content" id="hoshi2" style="text-align: left"></div>
                        <div class="tab-content" id="hoshi1" style="text-align: left"></div>
                        <div id="silhouette-skill"></div>
                    </div>
                </div>
                <div style="padding: 10px;">
                    <div class="container">
                        <div id="skill1"></div>
                    </div>
                    <div class="container">
                        <div id="skill2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´2 -->
    <div class="modal" id="skill-modal">
        <div class="modal-content">
            <span class="close" id="close-modal2">&times;</span>
            <div id="skill-pict"></div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´3 -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close" id="close-modal3">&times;</span>
            <h3>„Çπ„Ç≠„É´„ÇíÈÅ∏Êäû</h3>
            <div style="margin: 0.5rem 0;">
                <input type="text" id="categorySearch" placeholder="„Çπ„Ç≠„É´Ê§úÁ¥¢" oninput="renderCategoryList()">
                <button style="background-color: deeppink;" onclick="clearAllCategories()">ÂÖ®Ëß£Èô§</button>
            </div>
            <div id="categoryList"></div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player;
        let isPlaying = false;
        let currentVideoId = '';

        let selectedCategories = [];

        function onYouTubeIframeAPIReady() {
            // ÂàùÊúü„Åß„ÅØ‰Ωï„ÇÇË™≠„ÅøËæº„Åæ„Å™„ÅÑ
        }

        try {
            const response = await fetch('./data.json');
            const data = await response.json();

            const ITEMS_PER_PAGE = 90;
            let currentPage = 1;
            let filteredData = structuredClone(data.characters);
            const categories = data.skilltags;

            const searchInput = document.getElementById('search-input');
            const roleFilter = document.getElementById('role-filter');
            const sortOrder = document.getElementById('sort-order');
            const grid = document.getElementById('product-grid');
            const pagination = document.getElementById('pagination');
            const modal = document.getElementById('product-modal');
            const modal2 = document.getElementById('skill-modal');
            const modal3 = document.getElementById('categoryModal');
            const modalBody = document.getElementById('modal-body');
            const closeModal = document.getElementById('close-modal');
            const closeModal2 = document.getElementById('close-modal2');
            const closeModal3 = document.getElementById('close-modal3');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            function render() {
                const start = (currentPage - 1) * ITEMS_PER_PAGE;
                const end = start + ITEMS_PER_PAGE;
                const pageItems = filteredData.slice(start, end);

                grid.innerHTML = '';
                pageItems.forEach(character => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
          <img src="${character.imageURL}" alt="${character.imageURL}" style="width: 70%">
          <div style="font-size: small">${character.name}</div>
        `;
                    card.addEventListener('click', () => showModal(character));
                    grid.appendChild(card);
                });

                renderPagination();
            }

            function renderPagination() {
                const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
                pagination.innerHTML = '';

                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    if (i === currentPage) btn.disabled = true;
                    btn.addEventListener('click', () => {
                        currentPage = i;
                        render();
                    });
                    pagination.appendChild(btn);
                }
            }

            function applyFiltersAndSort() {
                const role = roleFilter.value;
                const sort = sortOrder.value;
                const keyword = searchInput.value.toLowerCase();

                filteredData = data.characters.filter(character =>
                    (role === 'all' || character.role === role) &&
                    character.name.toLowerCase().includes(keyword) &&
                    (selectedCategories.length === 0 || skillTagCheck(character))
                );
                currentPage = 1;
                render();
            }

            function skillTagCheck(character) {
                let flg = (character?.skills?.initial[0]?.tags !== 0 && character?.skills?.initial[0]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                    (character?.skills?.initial[1]?.tags !== 0 && character?.skills?.initial[1]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                    (character?.skills?.RK1[0]?.tags !== 0 && character?.skills?.RK1[0]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                    (character?.skills?.RK1[1]?.tags !== 0 && character?.skills?.RK1[1]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                    (character?.skills?.RK3[0]?.tags !== 0 && character?.skills?.RK3[0]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                    (character?.skills?.RK3[1]?.tags !== 0 && character?.skills?.RK3[1]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                    (character?.skills?.RK5[0]?.tags !== 0 && character?.skills?.RK5[0]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                    (character?.skills?.RK5[1]?.tags !== 0 && character?.skills?.RK5[1]?.tags?.some(tag => selectedCategories?.includes(tag)));

                if (Array.isArray(character.skills.RK7) && character.skills.RK7[0] && character.skills.RK7[0].name !== undefined) {
                    flg = flg ||
                        (character?.skills?.RK7[0]?.tags !== 0 && character?.skills?.RK7[0]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                        (character?.skills?.RK7[1]?.tags !== 0 && character?.skills?.RK7[1]?.tags?.some(tag => selectedCategories?.includes(tag)));
                }
                if (Array.isArray(character.skills.RK9) && character.skills.RK9[0] && character.skills.RK9[0].name !== undefined) {
                    flg = flg ||
                        (character?.skills?.RK9[0]?.tags !== 0 && character?.skills?.RK9[0]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                        (character?.skills?.RK9[1]?.tags !== 0 && character?.skills?.RK9[1]?.tags?.some(tag => selectedCategories?.includes(tag)));
                }
                if (Array.isArray(character.skills.RK11) && character.skills.RK11[0] && character.skills.RK11[0].name !== undefined) {
                    flg = flg ||
                        (character?.skills?.RK11[0]?.tags !== 0 && character?.skills?.RK11[0]?.tags?.some(tag => selectedCategories?.includes(tag))) ||
                        (character?.skills?.RK11[1]?.tags !== 0 && character?.skills?.RK11[1]?.tags?.some(tag => selectedCategories?.includes(tag)));
                }
                return flg;
            }

            function renderCategoryList() {
                const filter = categorySearch.value.toLowerCase();
                categoryList.innerHTML = categories
                    .filter(cat => cat.toLowerCase().includes(filter))
                    .map(cat => `<div class="category-item ${selectedCategories.includes(cat) ? 'active' : ''}" onclick="toggleCategory('${cat}')">${cat}</div>`).join('');
            }

            function toggleCategory(cat) {
                const index = selectedCategories.indexOf(cat);
                if (index >= 0) {
                    selectedCategories.splice(index, 1);
                } else {
                    selectedCategories.push(cat);
                }
                renderCategoryList();
                applyFiltersAndSort();
            }

            function clearAllCategories() {
                selectedCategories = [];
                renderCategoryList();
                applyFiltersAndSort()
            }

            function loadNewVideo(character) {
                currentVideoId = character.youtubeId;

                if (player) {
                    player.loadVideoById(currentVideoId);
                } else {
                    player = new YT.Player('player', {
                        height: '1',
                        width: '1',
                        videoId: currentVideoId,
                        playerVars: {
                            autoplay: 0,
                            controls: 0,
                            modestbranding: 1,
                            loop: 1,
                            playlist: currentVideoId,
                            rel: 0
                        },
                        events: {
                            onReady: () => {
                                document.getElementById('toggleButton').disabled = false;
                            }
                        }
                    });
                }
            }

            function showModal(character) {
                if (character.youtubeId !== undefined) {
                    document.getElementById('toggleButton').style = "";
                    loadNewVideo(character);
                } else document.getElementById('toggleButton').style = "display: none;";
                document.getElementById('characterImg').innerHTML = `<img style="width: 50%" src="${character.imageURL}" alt="${character.imageURL}">`;
                document.getElementById('characterName').innerHTML = `<h2>${character.name}</h2>`;
                document.getElementById('characterRole').innerHTML = `${character.role}`;
                document.getElementById('characterWeapon').innerHTML = `${character.weapon}`;
                document.getElementById('personalityImg').innerHTML = `<img style="width: 30%" src="${character.personality.imageURL}" alt="${character.personality.imageURL}">`;
                document.getElementById('personalityTitle').innerHTML = `<h2>${character.personality.title}</h2>`;
                if (character.personality.common !== undefined) {
                    document.getElementById('common').innerHTML = `${character.personality.common}`;
                } else {
                    document.getElementById('common').innerHTML = ``;
                }
                document.getElementById('hoshi5').innerHTML = `${character.personality.hoshi5}`;
                document.getElementById('hoshi4').innerHTML = `${character.personality.hoshi4}`;
                document.getElementById('hoshi3').innerHTML = `${character.personality.hoshi3}`;
                document.getElementById('hoshi2').innerHTML = `${character.personality.hoshi2}`;
                document.getElementById('hoshi1').innerHTML = `${character.personality.hoshi1}`;
                if (Array.isArray(character.skills.silhouetteSkill) && character.skills.silhouetteSkill[0] && character.skills.silhouetteSkill[0].name !== undefined) {
                    document.getElementById('silhouette-skill').innerHTML = `<img id="silhouette" class="skill" src="${character.skills.silhouetteSkill[0].imgURL}" alt="${character.skills.silhouetteSkill[0].imgURL}"><br>„Ç∑„É´„Ç®„ÉÉ„Éà„Çπ„Ç≠„É´`;
                    document.getElementById('silhouette-skill').addEventListener('click', () => showModal2(character, 'silhouetteSkill', 0));
                } else {
                    document.getElementById('silhouette-skill').innerHTML = ``;
                }

                let content = '';
                ranks = ['initial', 'RK1', 'RK3', 'RK5', 'RK7', 'RK9', 'RK11'];
                ranks.forEach(rank => content = addSkillContent(character, content, rank, 0));
                document.getElementById('skill1').innerHTML = content;
                ranks.forEach(rank => addSkillContentSettings(character, rank, 0));

                content = '';
                ranks.forEach(rank => content = addSkillContent(character, content, rank, 1));
                document.getElementById('skill2').innerHTML = content;
                ranks.forEach(rank => addSkillContentSettings(character, rank, 1));
                modal.style.display = 'flex';
            }

            function addSkillContent(character, content, key, index) {
                if (Array.isArray(character.skills[key]) && character.skills[key][index] && character.skills[key][index].name !== undefined) {
                    content += `<img id="${key}-${index}" class="skill" src="${character.skills[key][index].imgURL}" alt="${character.skills[key][index].imgURL}">`;
                }
                return content;
            }

            function addSkillContentSettings(character, key, index) {
                if (Array.isArray(character.skills[key]) && character.skills[key][index] && character.skills[key][index].name !== undefined) {
                    document.getElementById(key + '-' + index).addEventListener('click', () => showModal2(character, key, index));
                    if (character?.skills[key][index]?.tags !== 0 && character?.skills[key][index]?.tags?.some(tag => selectedCategories?.includes(tag))) {
                        document.getElementById(key + '-' + index).style = "background-color: lightcoral";
                    }
                }
            }

            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // „Çø„Éñ„Éú„Çø„É≥„ÅÆÂàá„ÇäÊõø„Åà
                    tabButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÂàá„ÇäÊõø„Åà
                    const target = btn.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(target).classList.add('active');
                });
            });

            function showModal2(character, key, index) {
                document.getElementById('skill-pict').innerHTML = `
              <img class="skill" src="${character.skills[key][index].imgURL}" alt="${character.skills[key][index].imgURL}">
              <h2>${character.skills[key][index].name}</h2>
              <div>„Çø„Ç§„ÉóÔºö${character.skills[key][index].type}</div>
              <div>„Ç≥„Çπ„ÉàÔºö${character.skills[key][index].cost}</div>
              <div>CDÔºö${character.skills[key][index].CD}</div>
              <div>${character.skills[key][index].desc}</div>
              `;
                modal2.style.display = 'flex';
            }

            closeModal.addEventListener('click', () => {
                modal.style.display = 'none';
                document.getElementById('toggleButton').textContent = '‚ñ∂';
                isPlaying = false;
                player.pauseVideo();
            });

            closeModal2.addEventListener('click', () => {
                modal2.style.display = 'none';
            });

            closeModal3.addEventListener('click', () => {
                modal3.style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    document.getElementById('toggleButton').textContent = '‚ñ∂';
                    isPlaying = false;
                    player.pauseVideo();
                }
                if (e.target === modal2) modal2.style.display = 'none';
            });

            window.addEventListener('touchend', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                    document.getElementById('toggleButton').textContent = '‚ñ∂';
                    isPlaying = false;
                    player.pauseVideo();
                }
                if (e.target.classList.contains('modal2')) {
                    e.target.style.display = 'none';
                }
            }, { passive: true });

            // „Ç§„Éô„É≥„ÉàÁôªÈå≤
            searchInput.addEventListener('input', applyFiltersAndSort);
            roleFilter.addEventListener('change', applyFiltersAndSort);
            sortOrder.addEventListener('change', applyFiltersAndSort);

            // ÂàùÊúüË°®Á§∫
            renderCategoryList();
            applyFiltersAndSort();

            function openModal(id) {
                document.getElementById(id).style.display = "flex";
            }

            function toggleAudio() {
                if (!player || typeof player.getPlayerState !== 'function') return;
                const state = player.getPlayerState();

                if (state !== YT.PlayerState.PLAYING) {
                    player.playVideo();
                    isPlaying = true;
                    document.getElementById('toggleButton').textContent = '‚ñ†';
                } else {
                    player.pauseVideo();
                    isPlaying = false;
                    document.getElementById('toggleButton').textContent = '‚ñ∂';
                }
            }

            function clearAllCategories() {
                selectedCategories = [];
                renderCategoryList();
                applyFiltersAndSort()
            }
        } catch (error) {
            console.error('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        }
    </script>
</body>

</html>